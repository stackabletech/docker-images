From 7821ce72d3ee572955828f90a96b8107a961b4c3 Mon Sep 17 00:00:00 2001
From: Andrew Kenworthy <andrew.kenworthy@stackable.tech>
Date: Fri, 23 Jan 2026 12:41:58 +0100
Subject: replace process groups root with root ID

---
 .../org/apache/nifi/util/NiFiProperties.java  |  3 ++
 .../nifi/flow/FlowInitializationCallback.java | 11 ++++
 .../FileAccessPolicyProvider.java             | 53 +++++++++++++++++++
 .../FileAuthorizerInitializer.java            | 25 +++++++++
 .../nifi/controller/StandardFlowService.java  | 17 ++++++
 5 files changed, 109 insertions(+)
 create mode 100644 nifi-framework-api/src/main/java/org/apache/nifi/flow/FlowInitializationCallback.java
 create mode 100644 nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAuthorizerInitializer.java

diff --git a/nifi-commons/nifi-properties/src/main/java/org/apache/nifi/util/NiFiProperties.java b/nifi-commons/nifi-properties/src/main/java/org/apache/nifi/util/NiFiProperties.java
index 45262a8f4f..e86f29b569 100644
--- a/nifi-commons/nifi-properties/src/main/java/org/apache/nifi/util/NiFiProperties.java
+++ b/nifi-commons/nifi-properties/src/main/java/org/apache/nifi/util/NiFiProperties.java
@@ -332,6 +332,9 @@ public class NiFiProperties extends ApplicationProperties {
     // performance tracking defaults
     public static final int DEFAULT_TRACK_PERFORMANCE_PERCENTAGE = 0;
 
+    // root process group replacement
+    public static final String ROOT_PROCESS_GROUP_PLACEHOLDER ="nifi.process.group.root.placeholder";
+
     // defaults
     public static final Boolean DEFAULT_AUTO_RESUME_STATE = true;
     public static final String DEFAULT_AUTHORIZER_CONFIGURATION_FILE = "conf/authorizers.xml";
diff --git a/nifi-framework-api/src/main/java/org/apache/nifi/flow/FlowInitializationCallback.java b/nifi-framework-api/src/main/java/org/apache/nifi/flow/FlowInitializationCallback.java
new file mode 100644
index 0000000000..7f81967537
--- /dev/null
+++ b/nifi-framework-api/src/main/java/org/apache/nifi/flow/FlowInitializationCallback.java
@@ -0,0 +1,11 @@
+package org.apache.nifi.flow;
+
+/**
+ * Simple callback interface invoked when the root process group has been
+ * loaded and the flow is fully initialized for the first time.
+ */
+public interface FlowInitializationCallback {
+    void onRootGroupLoaded();
+}
+
+
diff --git a/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAccessPolicyProvider.java b/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAccessPolicyProvider.java
index 3d271dd394..f153cea1ae 100644
--- a/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAccessPolicyProvider.java
+++ b/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAccessPolicyProvider.java
@@ -16,6 +16,7 @@
  */
 package org.apache.nifi.authorization;
 
+import jakarta.xml.bind.JAXBException;
 import org.apache.commons.lang3.StringUtils;
 import org.apache.nifi.authorization.annotation.AuthorizerContext;
 import org.apache.nifi.authorization.exception.AuthorizationAccessException;
@@ -26,6 +27,7 @@ import org.apache.nifi.authorization.resource.ResourceType;
 import org.apache.nifi.authorization.util.IdentityMapping;
 import org.apache.nifi.authorization.util.IdentityMappingUtil;
 import org.apache.nifi.components.PropertyValue;
+import org.apache.nifi.controller.StandardFlowService;
 import org.apache.nifi.util.FlowInfo;
 import org.apache.nifi.util.FlowParser;
 import org.apache.nifi.util.NiFiProperties;
@@ -58,6 +60,8 @@ import java.util.concurrent.atomic.AtomicReference;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
+import static org.apache.nifi.util.NiFiProperties.ROOT_PROCESS_GROUP_PLACEHOLDER;
+
 import static org.apache.nifi.authorization.RequestAction.READ;
 import static org.apache.nifi.authorization.RequestAction.WRITE;
 
@@ -92,6 +96,9 @@ public class FileAccessPolicyProvider implements ConfigurableAccessPolicyProvide
     @Override
     public void initialize(AccessPolicyProviderInitializationContext initializationContext) throws AuthorizerCreationException {
         userGroupProviderLookup = initializationContext.getUserGroupProviderLookup();
+
+        // Register flow initialization hook
+        StandardFlowService.registerInitializationCallback(new FileAuthorizerInitializer(this));
     }
 
     @Override
@@ -588,6 +595,52 @@ public class FileAccessPolicyProvider implements ConfigurableAccessPolicyProvide
         }
     }
 
+    /**
+     * Replaces process group root references with the process group ID.
+     * Relevant when a static authorizations file is provided, which can
+     * then use "root" as a placeholder.
+     */
+    public void replaceWithRootGroupId() throws JAXBException {
+        String placeholder = this.properties.getProperty(ROOT_PROCESS_GROUP_PLACEHOLDER, "");
+
+        if (StringUtils.isNotBlank(placeholder)) {
+            if (rootGroupId == null) {
+                logger.info("Parsing flow as rootGroupId is not yet defined");
+                parseFlow();
+            }
+            if (rootGroupId != null) {
+                logger.info("Parsing root group with {}", rootGroupId);
+
+                final AuthorizationsHolder holder = authorizationsHolder.get();
+                final List<AccessPolicy> currentPolicies = holder.getPolicies();
+                final ListIterator<AccessPolicy> accessPolicies = currentPolicies.listIterator();
+
+                boolean authorizationsChanged = false;
+
+                while (accessPolicies.hasNext()) {
+                    final AccessPolicy accessPolicy = accessPolicies.next();
+                    String resource = accessPolicy.getResource();
+                    String processGroupRoot = ResourceType.ProcessGroup.getValue() + "/" + placeholder;
+                    if (resource.endsWith(processGroupRoot)) {
+                        int pos = resource.indexOf(processGroupRoot);
+                        accessPolicies.remove();
+                        final AccessPolicy updatedPolicy = new AccessPolicy.Builder(accessPolicy).resource(resource.substring(0, pos) + ResourceType.ProcessGroup.getValue() + "/" + rootGroupId).build();
+                        accessPolicies.add(updatedPolicy);
+                        authorizationsChanged = true;
+                    }
+                }
+
+                if (authorizationsChanged) {
+                    saveAndRefreshHolder(currentPolicies);
+                }
+            } else {
+                // this is not expected as this is called from the flow service
+                // once it has been configured
+                logger.info("rootGroupId still not established!");
+            }
+        }
+    }
+
     /**
      * Creates and adds an access policy for the given resource, identity, and actions to the specified authorizations.
      *
diff --git a/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAuthorizerInitializer.java b/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAuthorizerInitializer.java
new file mode 100644
index 0000000000..f67328ef84
--- /dev/null
+++ b/nifi-framework-bundle/nifi-framework/nifi-file-authorizer/src/main/java/org/apache/nifi/authorization/FileAuthorizerInitializer.java
@@ -0,0 +1,25 @@
+package org.apache.nifi.authorization;
+
+import org.apache.nifi.flow.FlowInitializationCallback;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+
+public class FileAuthorizerInitializer implements FlowInitializationCallback {
+    private static final Logger logger = LoggerFactory.getLogger(FileAuthorizerInitializer.class);
+private FileAccessPolicyProvider fileAccessPolicyProvider;
+
+    public FileAuthorizerInitializer(FileAccessPolicyProvider fileAccessPolicyProvider) {
+        this.fileAccessPolicyProvider = fileAccessPolicyProvider;
+    }
+
+    @Override
+    public void onRootGroupLoaded() {
+        try {
+            logger.info("Flow initialized; ensuring root group ID is recorded in authorizations.xml");
+            this.fileAccessPolicyProvider.replaceWithRootGroupId();
+        } catch (Exception e) {
+            logger.warn("Unable to update authorizations.xml with root group ID", e);
+        }
+    }
+}
\ No newline at end of file
diff --git a/nifi-framework-bundle/nifi-framework/nifi-framework-core/src/main/java/org/apache/nifi/controller/StandardFlowService.java b/nifi-framework-bundle/nifi-framework/nifi-framework-core/src/main/java/org/apache/nifi/controller/StandardFlowService.java
index 5de3486164..2873b26644 100644
--- a/nifi-framework-bundle/nifi-framework/nifi-framework-core/src/main/java/org/apache/nifi/controller/StandardFlowService.java
+++ b/nifi-framework-bundle/nifi-framework/nifi-framework-core/src/main/java/org/apache/nifi/controller/StandardFlowService.java
@@ -55,6 +55,7 @@ import org.apache.nifi.controller.serialization.FlowSynchronizationException;
 import org.apache.nifi.controller.status.ProcessGroupStatus;
 import org.apache.nifi.engine.FlowEngine;
 import org.apache.nifi.events.BulletinFactory;
+import org.apache.nifi.flow.FlowInitializationCallback;
 import org.apache.nifi.groups.BundleUpdateStrategy;
 import org.apache.nifi.groups.ProcessGroup;
 import org.apache.nifi.groups.RemoteProcessGroup;
@@ -148,6 +149,13 @@ public class StandardFlowService implements FlowService, ProtocolHandler {
     private static final String CONNECTION_EXCEPTION_MSG_PREFIX = "Failed to connect node to cluster";
     private static final Logger logger = LoggerFactory.getLogger(StandardFlowService.class);
 
+    // Static callback registration for post-initialization hooks
+    private static volatile FlowInitializationCallback initializationCallback;
+
+    public static void registerInitializationCallback(FlowInitializationCallback callback) {
+        initializationCallback = callback;
+    }
+
     public static StandardFlowService createStandaloneInstance(
             final FlowController controller,
             final NiFiProperties nifiProperties,
@@ -935,6 +943,15 @@ public class StandardFlowService implements FlowService, ProtocolHandler {
             // start the processors as indicated by the dataflow
             controller.onFlowInitialized(autoResumeState);
 
+            // this should be done once the flow has been initialized
+            if (initializationCallback != null) {
+                try {
+                    initializationCallback.onRootGroupLoaded();
+                } catch (Exception e) {
+                    logger.warn("Error invoking FlowInitializationCallback", e);
+                }
+            }
+
             loadSnippets(dataFlow.getSnippets());
 
             controller.startHeartbeating();
