From 3ab66fc0d92bbdf2b96c58af26c9ad6ca31a2b8a Mon Sep 17 00:00:00 2001
From: Sebastian Bernauer <sebastian.bernauer@stackable.de>
Date: Thu, 11 Apr 2024 15:41:05 +0200
Subject: [PATCH] HIVE-21939: protoc:2.5.0 dependence has broken building on
 aarch64

Cherry-picked from 2baf21bb55fcf33d8522444c78a8d8cab60e7415

Co-authored-by: Chinna Rao L <chinnaraol@apache.org>
---
 standalone-metastore/pom.xml | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/standalone-metastore/pom.xml b/standalone-metastore/pom.xml
index e36f1e64f0..726eeba197 100644
--- a/standalone-metastore/pom.xml
+++ b/standalone-metastore/pom.xml
@@ -81,7 +81,9 @@
     <log4j2.version>2.17.1</log4j2.version>
     <mockito-all.version>1.10.19</mockito-all.version>
     <orc.version>1.5.1</orc.version>
-    <protobuf.version>2.5.0</protobuf.version>
+    <!-- com.google repo will be used except on Aarch64 platform. -->
+    <protobuf.group>com.google.protobuf</protobuf.group>
+    <protobuf.version>2.6.1</protobuf.version>
     <sqlline.version>1.3.0</sqlline.version>
     <storage-api.version>2.7.0</storage-api.version>
 
@@ -124,7 +126,7 @@
       <version>${guava.version}</version>
     </dependency>
     <dependency>
-      <groupId>com.google.protobuf</groupId>
+      <groupId>${protobuf.group}</groupId>
       <artifactId>protobuf-java</artifactId>
       <version>${protobuf.version}</version>
     </dependency>
@@ -443,6 +445,19 @@
         </plugins>
       </build>
     </profile>
+    <!-- use com.github.os72 on aarch64 platform -->
+    <profile>
+      <id>aarch64</id>
+      <properties>
+        <protobuf.group>com.github.os72</protobuf.group>
+      </properties>
+      <activation>
+        <os>
+          <family>linux</family>
+          <arch>aarch64</arch>
+        </os>
+      </activation>
+      </profile>
       <!--
     <profile>
       <id>checkin</id>
@@ -604,7 +619,7 @@
               <goal>run</goal>
             </goals>
             <configuration>
-              <protocArtifact>com.google.protobuf:protoc:2.5.0</protocArtifact>
+              <protocArtifact>com.google.protobuf:protoc:2.6.1</protocArtifact>
               <addSources>none</addSources>
               <inputDirectories>
                 <include>${basedir}/src/main/protobuf/org/apache/hadoop/hive/metastore</include>
-- 
2.43.0

