From 5f5d7b789f553a6bc75ceee04bf630ec53b115b7 Mon Sep 17 00:00:00 2001
From: Jed Laundry <jlaundry@jlaundry.com>
Date: Wed, 7 Jan 2026 18:29:34 +0000
Subject: replace deprecated hyper::body::to_bytes

Signed-off-by: Jed Laundry <jlaundry@jlaundry.com>
---
 src/sinks/azure_logs_ingestion/service.rs |  3 +-
 src/sinks/azure_logs_ingestion/tests.rs   | 79 +++++++++++++++++++++--
 2 files changed, 76 insertions(+), 6 deletions(-)

diff --git a/src/sinks/azure_logs_ingestion/service.rs b/src/sinks/azure_logs_ingestion/service.rs
index 154646189..261683c38 100644
--- a/src/sinks/azure_logs_ingestion/service.rs
+++ b/src/sinks/azure_logs_ingestion/service.rs
@@ -157,8 +157,7 @@ impl AzureLogsIngestionService {
             }
 
             if res.status() == StatusCode::BAD_REQUEST {
-                #[allow(deprecated)]
-                let body_bytes: Bytes = hyper::body::to_bytes(res.into_body()).await.unwrap();
+                let body_bytes: Bytes = http_body::Body::collect(res.into_body()).await?.to_bytes();
                 let body_string: String = String::from_utf8(body_bytes.to_vec()).unwrap();
                 let err_string: String = format!("Azure returned 400 Bad Request: {body_string}");
                 return Err(err_string.into());
diff --git a/src/sinks/azure_logs_ingestion/tests.rs b/src/sinks/azure_logs_ingestion/tests.rs
index b157f7f12..3e8a1335c 100644
--- a/src/sinks/azure_logs_ingestion/tests.rs
+++ b/src/sinks/azure_logs_ingestion/tests.rs
@@ -1,6 +1,6 @@
+use bytes::Bytes;
 use futures::stream;
 use http::Response;
-use hyper::body;
 use std::time::Duration;
 use tokio::time::timeout;
 use vector_lib::config::log_schema;
@@ -265,9 +265,11 @@ async fn correct_request() {
     let (parts, body) = request.into_parts();
     assert_eq!(&parts.method.to_string(), "POST");
 
-    #[allow(deprecated)]
-    let body = body::to_bytes(body).await.unwrap();
-    let body_json: serde_json::Value = serde_json::from_slice(&body[..]).unwrap();
+    let body_bytes: Bytes = http_body::Body::collect(body)
+        .await
+        .expect("failed to collect body")
+        .to_bytes();
+    let body_json: serde_json::Value = serde_json::from_slice(&body_bytes[..]).unwrap();
     let expected_json = serde_json::json!([
         {
             "TimeGenerated": timestamp_value1,
@@ -311,6 +313,75 @@ fn create_mock_credential() -> impl TokenCredential {
     MockCredential
 }
 
+#[tokio::test]
+async fn mock_healthcheck_with_400_response() {
+    let config: AzureLogsIngestionConfig = toml::from_str(
+        r#"
+            endpoint = "http://localhost:9001"
+            dcr_immutable_id = "dcr-00000000000000000000000000000000"
+            stream_name = "Custom-UnitTest"
+
+            [auth]
+            azure_tenant_id = "00000000-0000-0000-0000-000000000000"
+            azure_client_id = "mock-client-id"
+            azure_client_secret = "mock-client-secret"
+        "#,
+    )
+    .unwrap();
+
+    let mut log1 = [("message", "hello")].iter().copied().collect::<LogEvent>();
+    let (_timestamp_key1, _timestamp_value1) = insert_timestamp_kv(&mut log1);
+
+    let (endpoint_tx, _endpoint_rx) = tokio::sync::mpsc::channel(1);
+    let mock_endpoint = spawn_blackhole_http_server(move |request| {
+        let endpoint_tx = endpoint_tx.clone();
+        async move {
+            endpoint_tx.send(request).await.unwrap();
+            let body = serde_json::json!({
+                "error": "Mock400ErrorResponse",
+            })
+            .to_string();
+
+            Ok(Response::builder()
+                .status(400)
+                .header("Content-Type", "application/json")
+                .body(body.into())
+                .unwrap())
+        }
+    })
+    .await;
+
+    let context = SinkContext::default();
+    let credential = std::sync::Arc::new(create_mock_credential());
+
+    let (_sink, healthcheck) = config
+        .build_inner(
+            context,
+            mock_endpoint.into(),
+            config.dcr_immutable_id.clone(),
+            config.stream_name.clone(),
+            credential,
+            config.token_scope.clone(),
+            config.timestamp_field.clone(),
+        )
+        .await
+        .unwrap();
+
+    let hc_err = healthcheck.await.unwrap_err();
+    let err_str = hc_err.to_string();
+    // Both generic 400 "Bad Request", and our mock error message should be present
+    assert!(
+        err_str.contains("Bad Request"),
+        "Healthcheck error does not contain 'Bad Request': {}",
+        err_str
+    );
+    assert!(
+        err_str.contains("Mock400ErrorResponse"),
+        "Healthcheck error does not contain 'Mock400ErrorResponse': {}",
+        err_str
+    );
+}
+
 #[tokio::test]
 async fn mock_healthcheck_with_403_response() {
     let config: AzureLogsIngestionConfig = toml::from_str(
