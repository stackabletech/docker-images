From 8acb7b19800288b92380e4a398ca019ed61c93ea Mon Sep 17 00:00:00 2001
From: Jed Laundry <jlaundry@jlaundry.com>
Date: Sat, 2 Nov 2024 23:22:14 +0000
Subject: parameterise the dcr_immutable_id and stream_name

Signed-off-by: Jed Laundry <jlaundry@jlaundry.com>
---
 src/sinks/azure_logs_ingestion/config.rs  | 25 +++++++++++++++--------
 src/sinks/azure_logs_ingestion/service.rs | 22 ++++++++++++--------
 2 files changed, 31 insertions(+), 16 deletions(-)

diff --git a/src/sinks/azure_logs_ingestion/config.rs b/src/sinks/azure_logs_ingestion/config.rs
index 5d5a0ef9c..711ceae98 100644
--- a/src/sinks/azure_logs_ingestion/config.rs
+++ b/src/sinks/azure_logs_ingestion/config.rs
@@ -40,11 +40,11 @@ pub struct AzureLogsIngestionConfig {
     #[configurable(metadata(docs::examples = "https://my-dce-5kyl.eastus-1.ingest.monitor.azure.com"))]
     pub endpoint: String,
 
-    /// The [Data collection rule][dcr] for the Data collection endpoint.
+    /// The [Data collection rule immutable ID][dcr_immutable_id] for the Data collection endpoint.
     ///
-    /// [dcr]: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/logs-ingestion-api-overview
+    /// [dcr_immutable_id]: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/logs-ingestion-api-overview
     #[configurable(metadata(docs::examples = "dcr-000a00a000a00000a000000aa000a0aa"))]
-    pub dcr: String,
+    pub dcr_immutable_id: String,
 
     /// The [Stream name][stream_name] for the Data collection rule.
     ///
@@ -88,7 +88,7 @@ impl Default for AzureLogsIngestionConfig {
     fn default() -> Self {
         Self {
             endpoint: Default::default(),
-            dcr: Default::default(),
+            dcr_immutable_id: Default::default(),
             stream_name: Default::default(),
             token_scope: default_scope(),
             encoding: Default::default(),
@@ -106,6 +106,8 @@ impl AzureLogsIngestionConfig {
         &self,
         cx: SinkContext,
         endpoint: UriSerde,
+        dcr_immutable_id: String,
+        stream_name: String,
         token_scope: String,
     ) -> crate::Result<(VectorSink, Healthcheck)> {
         let endpoint = endpoint.with_default_parts().uri;
@@ -127,6 +129,8 @@ impl AzureLogsIngestionConfig {
         let service = AzureLogsIngestionService::new(
             client,
             endpoint,
+            dcr_immutable_id,
+            stream_name,
             credential,
             token_scope,
         )?;
@@ -156,10 +160,15 @@ impl_generate_config_from_default!(AzureLogsIngestionConfig);
 #[typetag::serde(name = "azure_logs_ingestion")]
 impl SinkConfig for AzureLogsIngestionConfig {
     async fn build(&self, cx: SinkContext) -> crate::Result<(VectorSink, Healthcheck)> {
-        // https://my-dce-5kyl.eastus-1.ingest.monitor.azure.com/dataCollectionRules/dcr-000a00a000a00000a000000aa000a0aa/streams/Custom-MyTable?api-version=2023-01-01
-        // let endpoint = format!("{}/dataCollectionRules/{}/streams/{}", self.endpoint, self.dcr, self.stream_name).parse()?;
-        let endpoint = self.endpoint.parse()?;
-        self.build_inner(cx, endpoint).await
+
+        let endpoint: UriSerde = self.endpoint.parse()?;
+        self.build_inner(
+            cx,
+            endpoint,
+            self.dcr_immutable_id.clone(),
+            self.stream_name.clone(),
+            self.token_scope.clone(),
+        ).await
     }
 
     fn input(&self) -> Input {
diff --git a/src/sinks/azure_logs_ingestion/service.rs b/src/sinks/azure_logs_ingestion/service.rs
index a4ff46c55..757ccc5a7 100644
--- a/src/sinks/azure_logs_ingestion/service.rs
+++ b/src/sinks/azure_logs_ingestion/service.rs
@@ -15,7 +15,10 @@ use tracing::Instrument;
 
 use crate::{http::HttpClient, sinks::prelude::*};
 
-// JSON content type of logs
+/// Log Ingestion API version
+const API_VERSION: &str = "2023-01-01";
+
+/// JSON content type of logs
 const CONTENT_TYPE: &str = "application/json";
 
 static CONTENT_TYPE_VALUE: LazyLock<HeaderValue> =
@@ -84,16 +87,19 @@ impl AzureLogsIngestionService {
     pub fn new(
         client: HttpClient,
         endpoint: Uri,
+        dcr_immutable_id: String,
+        stream_name: String,
         credential: Arc<dyn TokenCredential>,
         token_scope: String,
     ) -> crate::Result<Self> {
-        // let mut parts = endpoint.into_parts();
-        // parts.path_and_query = Some(
-        //     format!("a9ee8e5b-ed0e-4980-9b9c-15e1f939db7f?api-version={API_VERSION}")
-        //         .parse()
-        //         .expect("query should never fail to parse"),
-        // );
-        // let endpoint = Uri::from_parts(parts)?;
+        let mut parts = endpoint.into_parts();
+        parts.path_and_query = Some(
+            // https://my-dce-5kyl.eastus-1.ingest.monitor.azure.com/dataCollectionRules/dcr-000a00a000a00000a000000aa000a0aa/streams/Custom-MyTable?api-version=2023-01-01
+            format!("/dataCollectionRules/{dcr_immutable_id}/streams/{stream_name}?api-version={API_VERSION}")
+                .parse()
+                .expect("path and query should never fail to parse"),
+        );
+        let endpoint = Uri::from_parts(parts)?;
 
         let default_headers = {
             let mut headers = HeaderMap::new();
