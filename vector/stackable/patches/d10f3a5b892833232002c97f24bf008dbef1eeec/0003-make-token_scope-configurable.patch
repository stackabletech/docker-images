From 809f9cfe18017b4eafd82d2883a1982b8f80bbf1 Mon Sep 17 00:00:00 2001
From: Jed Laundry <jlaundry@jlaundry.com>
Date: Sat, 2 Nov 2024 23:18:16 +0000
Subject: make token_scope configurable

Signed-off-by: Jed Laundry <jlaundry@jlaundry.com>
---
 src/sinks/azure_logs_ingestion/config.rs  | 16 ++++++++++++++--
 src/sinks/azure_logs_ingestion/service.rs |  5 ++++-
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/src/sinks/azure_logs_ingestion/config.rs b/src/sinks/azure_logs_ingestion/config.rs
index 5c1249363..5d5a0ef9c 100644
--- a/src/sinks/azure_logs_ingestion/config.rs
+++ b/src/sinks/azure_logs_ingestion/config.rs
@@ -22,8 +22,9 @@ use super::{
 /// Max number of bytes in request body
 const MAX_BATCH_SIZE: usize = 30 * 1024 * 1024;
 
-// Log Ingestion API version
-// const API_VERSION: &str = "2023-01-01";
+pub(super) fn default_scope() -> String {
+    "https://monitor.azure.com/.default".into()
+}
 
 /// Configuration for the `azure_logs_ingestion` sink.
 #[configurable_component(sink(
@@ -51,6 +52,14 @@ pub struct AzureLogsIngestionConfig {
     #[configurable(metadata(docs::examples = "Custom-MyTable"))]
     pub stream_name: String,
 
+    /// [Token scope][token_scope] for dedicated Azure regions.
+    ///
+    /// [token_scope]: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/logs-ingestion-api-overview
+    #[configurable(metadata(docs::examples = "https://monitor.azure.us/.default"))]
+    #[configurable(metadata(docs::examples = "https://monitor.azure.cn/.default"))]
+    #[serde(default = "default_scope")]
+    pub(super) token_scope: String,
+
     #[configurable(derived)]
     #[serde(default, skip_serializing_if = "crate::serde::is_default")]
     pub encoding: Transformer,
@@ -81,6 +90,7 @@ impl Default for AzureLogsIngestionConfig {
             endpoint: Default::default(),
             dcr: Default::default(),
             stream_name: Default::default(),
+            token_scope: default_scope(),
             encoding: Default::default(),
             batch: Default::default(),
             request: Default::default(),
@@ -96,6 +106,7 @@ impl AzureLogsIngestionConfig {
         &self,
         cx: SinkContext,
         endpoint: UriSerde,
+        token_scope: String,
     ) -> crate::Result<(VectorSink, Healthcheck)> {
         let endpoint = endpoint.with_default_parts().uri;
         let protocol = get_http_scheme_from_uri(&endpoint).to_string();
@@ -117,6 +128,7 @@ impl AzureLogsIngestionConfig {
             client,
             endpoint,
             credential,
+            token_scope,
         )?;
         let healthcheck = service.healthcheck();
 
diff --git a/src/sinks/azure_logs_ingestion/service.rs b/src/sinks/azure_logs_ingestion/service.rs
index ad01bbb05..a4ff46c55 100644
--- a/src/sinks/azure_logs_ingestion/service.rs
+++ b/src/sinks/azure_logs_ingestion/service.rs
@@ -75,6 +75,7 @@ pub struct AzureLogsIngestionService {
     client: HttpClient,
     endpoint: Uri,
     credential: Arc<dyn TokenCredential>,
+    token_scope: String,
     default_headers: HeaderMap,
 }
 
@@ -84,6 +85,7 @@ impl AzureLogsIngestionService {
         client: HttpClient,
         endpoint: Uri,
         credential: Arc<dyn TokenCredential>,
+        token_scope: String,
     ) -> crate::Result<Self> {
         // let mut parts = endpoint.into_parts();
         // parts.path_and_query = Some(
@@ -104,6 +106,7 @@ impl AzureLogsIngestionService {
             client,
             endpoint,
             credential,
+            token_scope,
             default_headers,
         })
     }
@@ -113,7 +116,7 @@ impl AzureLogsIngestionService {
 
         // TODO: make this an option, for soverign clouds
         let access_token = executor::block_on(self.credential
-            .get_token(&["https://monitor.azure.com/.default"]))
+            .get_token(&[&self.token_scope]))
             .expect("failed to get access token from credential");
         
         let bearer = format!("Bearer {}", access_token.token.secret());
