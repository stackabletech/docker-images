From e997eafbc4b9d8158077255b2e71c474561be67b Mon Sep 17 00:00:00 2001
From: Jed Laundry <jlaundry@jlaundry.com>
Date: Sat, 6 Dec 2025 19:53:19 +0000
Subject: rebase, test with explicit credentials

Signed-off-by: Jed Laundry <jlaundry@jlaundry.com>
---
 src/sinks/azure_logs_ingestion/config.rs  | 30 ++++++++++++++++++++---
 src/sinks/azure_logs_ingestion/service.rs |  7 +++---
 2 files changed, 31 insertions(+), 6 deletions(-)

diff --git a/src/sinks/azure_logs_ingestion/config.rs b/src/sinks/azure_logs_ingestion/config.rs
index 77a0baea1..6f9dea703 100644
--- a/src/sinks/azure_logs_ingestion/config.rs
+++ b/src/sinks/azure_logs_ingestion/config.rs
@@ -1,6 +1,7 @@
 use std::sync::Arc;
 
-use azure_core::auth::TokenCredential;
+use azure_core::credentials::TokenCredential;
+use azure_identity::ClientSecretCredential;
 use vector_lib::configurable::configurable_component;
 use vector_lib::schema;
 use vrl::value::Kind;
@@ -57,6 +58,18 @@ pub struct AzureLogsIngestionConfig {
     #[configurable(metadata(docs::examples = "Custom-MyTable"))]
     pub stream_name: String,
 
+    /// The [Azure Tenant ID][azure_tenant_id].
+    #[configurable(metadata(docs::examples = "00000000-0000-0000-0000-000000000000"))]
+    pub azure_tenant_id: String,
+
+    /// The [Azure Client ID][azure_client_id].
+    #[configurable(metadata(docs::examples = "00000000-0000-0000-0000-000000000000"))]
+    pub azure_client_id: String,
+
+    /// The [Azure Client Secret][azure_client_secret].
+    #[configurable(metadata(docs::examples = "00-00~000000-0000000~0000000000000000000"))]
+    pub azure_client_secret: String,
+
     /// [Token scope][token_scope] for dedicated Azure regions.
     ///
     /// [token_scope]: https://learn.microsoft.com/en-us/azure/azure-monitor/logs/logs-ingestion-api-overview
@@ -106,6 +119,9 @@ impl Default for AzureLogsIngestionConfig {
             endpoint: Default::default(),
             dcr_immutable_id: Default::default(),
             stream_name: Default::default(),
+            azure_tenant_id: Default::default(),
+            azure_client_id: Default::default(),
+            azure_client_secret: Default::default(),
             token_scope: default_scope(),
             timestamp_field: default_timestamp_field(),
             encoding: Default::default(),
@@ -124,6 +140,7 @@ impl AzureLogsIngestionConfig {
         endpoint: UriSerde,
         dcr_immutable_id: String,
         stream_name: String,
+        credential: Arc<dyn TokenCredential>,
         token_scope: String,
         timestamp_field: String,
     ) -> crate::Result<(VectorSink, Healthcheck)> {
@@ -136,8 +153,6 @@ impl AzureLogsIngestionConfig {
             .limit_max_bytes(MAX_BATCH_SIZE)?
             .into_batcher_settings()?;
 
-        let credential: Arc<dyn TokenCredential> = azure_identity::create_credential()?;
-
         let tls_settings = TlsSettings::from_options(self.tls.as_ref())?;
         let client = HttpClient::new(Some(tls_settings), &cx.proxy)?;
 
@@ -177,11 +192,20 @@ impl_generate_config_from_default!(AzureLogsIngestionConfig);
 impl SinkConfig for AzureLogsIngestionConfig {
     async fn build(&self, cx: SinkContext) -> crate::Result<(VectorSink, Healthcheck)> {
         let endpoint: UriSerde = self.endpoint.parse()?;
+
+        let credential: Arc<dyn TokenCredential> = ClientSecretCredential::new(
+            &self.azure_tenant_id.clone(),
+            self.azure_client_id.clone(),
+            self.azure_client_secret.clone().into(),
+            None,
+        )?;
+
         self.build_inner(
             cx,
             endpoint,
             self.dcr_immutable_id.clone(),
             self.stream_name.clone(),
+            credential,
             self.token_scope.clone(),
             self.timestamp_field.clone(),
         )
diff --git a/src/sinks/azure_logs_ingestion/service.rs b/src/sinks/azure_logs_ingestion/service.rs
index 1544c71a8..d9762a329 100644
--- a/src/sinks/azure_logs_ingestion/service.rs
+++ b/src/sinks/azure_logs_ingestion/service.rs
@@ -3,7 +3,7 @@ use std::sync::Arc;
 use std::sync::LazyLock;
 use std::task::{Context, Poll};
 
-use azure_core::auth::TokenCredential;
+use azure_core::credentials::TokenCredential;
 
 use bytes::Bytes;
 use http::{
@@ -118,8 +118,9 @@ impl AzureLogsIngestionService {
         let mut request = Request::post(&self.endpoint).body(Body::from(body))?;
 
         // TODO: make this an option, for soverign clouds
-        let access_token = executor::block_on(self.credential.get_token(&[&self.token_scope]))
-            .expect("failed to get access token from credential");
+        let access_token = executor::block_on(
+            self.credential.get_token(&[&self.token_scope], None)
+        ).expect("failed to get access token from credential");
 
         let bearer = format!("Bearer {}", access_token.token.secret());
 
