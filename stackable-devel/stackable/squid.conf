#
# Squid configuration for Stackable build filtering
# Only allows HTTP/HTTPS connections to approved domains
#

# Basic Configuration
http_port 3128

# Disable cache completely for simplicity
cache deny all
cache_mem 1 MB

# Logging - Log ALL requests including blocked ones
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# Process ownership
cache_effective_user squid
cache_effective_group squid

# ACL Definitions - ALLOWLIST ONLY
# Define allowed domains
acl stackable_domains dstdomain .stackable.tech
acl red_hat_domains dstdomain registry.access.redhat.com cdn-ubi.redhat.com
acl github_domains dstdomain github.com
acl rust_domains dstdomain sh.rustup.rs static.rust-lang.org index.crates.io static.crates.io
acl python_domains dstdomain pypi.org files.pythonhosted.org

# Standard ACLs (simplified)
acl localnet src 127.0.0.0/8
acl SSL_ports port 443
acl Safe_ports port 80 443
acl CONNECT method CONNECT

# Access Rules - ALLOWLIST APPROACH
# Allow HTTPS to safe ports only
http_access deny CONNECT !SSL_ports

# Allow only safe ports
http_access deny !Safe_ports

# Allow localhost to access ONLY approved domains
http_access allow localnet stackable_domains
http_access allow localnet red_hat_domains
http_access allow localnet rust_domains
http_access allow localnet github_domains
http_access allow localnet python_domains

# BLOCK EVERYTHING ELSE (including localhost to other domains)
http_access deny all

# Security Settings
forwarded_for off
via off

# DNS settings
dns_nameservers 8.8.8.8 8.8.4.4
