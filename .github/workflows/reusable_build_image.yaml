on:
  workflow_call:
    inputs:
      product-name:
        required: true
        type: string
      sdp-version:
        required: true
        type: string
      registry-namespace:
        required: true
        type: string
      runners:
        description: |
          The type of runners used.
          - `mixed`: x86_64 builds run on the GitHub hosted runners and the aarch64 builds run on the Ubicloud runners
          - `ubicloud`: Both the x86_64 and the aarch64 builds run on the Ubicloud runners
        default: mixed
        type: string
    secrets:
      harbor-robot-secret:
        description: The secret for the Harbor robot user used to push images and manifest
        required: true
      slack-token:
        description: The Slack token used to post failure notifications
        required: true

jobs:
  generate_runner_dimension:
    name: Generate Runner Dimension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - id: runners
        shell: bash
        env:
          RUNNERS_TYPE: ${{ inputs.runners }}
        run: |
          if [ "$RUNNERS_TYPE" == "mixed" ]; then
            RUNNERS=$(cat .github/workflows/runners/mixed.json | jq --compact-output)
            echo "RUNNERS=$RUNNERS" | tee -a "$GITHUB_OUTPUT"
          elif [ "$RUNNERS_TYPE" == "ubicloud" ]; then
            RUNNERS=$(cat .github/workflows/runners/ubicloud.json | jq --compact-output)
            echo "RUNNERS=$RUNNERS" | tee -a "$GITHUB_OUTPUT"
          else
            echo "Invalid runners type, expected 'mixed' or 'ubicloud'"
            exit 1
          fi
    outputs:
      runners: ${{ steps.runners.outputs.RUNNERS }}

  generate_version_dimension:
    name: Generate Version Dimension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - id: shard
        uses: stackabletech/actions/shard@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1
        with:
          product-name: ${{ inputs.product-name }}
    outputs:
      versions: ${{ steps.shard.outputs.versions }}

  build:
    name: Build/Publish ${{ matrix.versions }}-${{ matrix.runner.arch }} Image
    needs:
      - generate_version_dimension
      - generate_runner_dimension
    permissions:
      id-token: write
    runs-on: ${{ matrix.runner.name }}
    strategy:
      fail-fast: false
      matrix:
        versions: ${{ fromJson(needs.generate_version_dimension.outputs.versions) }}
        runner: ${{ fromJson(needs.generate_runner_dimension.outputs.runners) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Free Disk Space
        uses: stackabletech/actions/free-disk-space@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1

      - name: Build Product Image
        id: build
        uses: stackabletech/actions/build-product-image@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1
        with:
          registry-namespace: ${{ inputs.registry-namespace }}
          product-name: ${{ inputs.product-name }}
          product-version: ${{ matrix.versions }}
          sdp-version: ${{ inputs.sdp-version }}

      - name: Publish Container Image on oci.stackable.tech
        uses: stackabletech/actions/publish-image@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1
        with:
          image-registry-uri: oci.stackable.tech
          image-registry-username: robot$${{ inputs.registry-namespace }}+github-action-build
          image-registry-password: ${{ secrets.harbor-robot-secret }}
          image-repository: ${{ inputs.registry-namespace }}/${{ inputs.product-name }}
          image-manifest-tag: ${{ steps.build.outputs.image-manifest-tag }}
          source-image-uri: localhost/${{ inputs.registry-namespace }}/${{ inputs.product-name }}:${{ steps.build.outputs.image-manifest-tag }}

  publish_manifests:
    name: Build/Publish ${{ matrix.versions }} Manifests
    needs: [generate_version_dimension, build]
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        versions: ${{ fromJson(needs.generate_version_dimension.outputs.versions) }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Publish and Sign Image Index Manifest to oci.stackable.tech
        uses: stackabletech/actions/publish-image-index-manifest@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1
        with:
          image-registry-uri: oci.stackable.tech
          image-registry-username: robot$${{ inputs.registry-namespace }}+github-action-build
          image-registry-password: ${{ secrets.harbor-robot-secret }}
          image-repository: ${{ inputs.registry-namespace }}/${{ inputs.product-name }}
          image-index-manifest-tag: ${{ matrix.versions }}-stackable${{ inputs.sdp-version }}

  notify:
    name: Failure Notification
    needs: [generate_version_dimension, build, publish_manifests]
    runs-on: ubuntu-latest
    if: failure() || (github.run_attempt > 1 && !cancelled())
    steps:
      - name: Send Notification
        uses: stackabletech/actions/send-slack-notification@a5d39a4eb109bb6af3c152800701c86e98bfe1a5 # v0.10.1
        with:
          publish-manifests-result: ${{ needs.publish_manifests.result }}
          build-result: ${{ needs.build.result }}
          slack-token: ${{ secrets.slack-token }}
          channel-id: C07UG6JH44F # notifications-container-images
          type: container-image-build
