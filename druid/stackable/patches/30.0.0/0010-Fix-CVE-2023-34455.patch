From 4832e1270c2f541ad3724455034cbec394ba6263 Mon Sep 17 00:00:00 2001
From: Razvan-Daniel Mihai <84674+razvan@users.noreply.github.com>
Date: Tue, 28 Jan 2025 17:29:59 +0100
Subject: Fix CVE-2023-34455

see https://github.com/stackabletech/vulnerabilities/issues/558

At the end of build process, Druid downloads dependencies directly from a remote
Maven repository ignoring existing patches that have been applyed locally.
These dependencies include all transitive dependencies too.
The hadoop client depends on a vulnerable version of the snappy library which
is then also downloaded even though a newer version is already on the system.

This patch removes the vulnerable jars.
---
 distribution/pom.xml | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/distribution/pom.xml b/distribution/pom.xml
index d5918710ef..2d5bfc6ab4 100644
--- a/distribution/pom.xml
+++ b/distribution/pom.xml
@@ -259,6 +259,20 @@
                                     </arguments>
                                 </configuration>
                             </execution>
+                            <execution>
+                                <id>fix-cve-2023-34455-remove-snappy</id>
+                                <phase>package</phase>
+                                <goals>
+                                    <goal>exec</goal>
+                                </goals>
+                                <configuration>
+                                  <executable>/usr/bin/rm</executable>
+                                    <arguments>
+                                      <argument>${project.build.directory}/hadoop-dependencies/hadoop-client-api/3.3.6/snappy-java-1.1.8.2.jar</argument>
+                                      <argument>${project.build.directory}/hadoop-dependencies/hadoop-client-runtime/3.3.6/snappy-java-1.1.8.2.jar</argument>
+                                    </arguments>
+                                </configuration>
+                            </execution>
                         </executions>
                     </plugin>
                     <plugin>
